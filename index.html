<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audiotube | Broadcast Yourself</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #ff4500;
            --primary-glow: rgba(255, 69, 0, 0.4);
            --bg-dark: #0a0a0a;
            --bg-card: #161616;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --border: #333;
            --font-mono: 'JetBrains Mono', monospace;
            --font-display: 'Space Grotesk', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-display);
            background-color: var(--bg-dark);
            color: var(--text-main);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- UI Components --- */
        header {
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 15px var(--primary-glow);
            cursor: pointer;
        }

        h1 span { color: var(--primary); }

        nav {
            display: flex;
            gap: 2rem;
            margin-left: 3rem;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-link.active { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }

        .container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1rem;
            width: 100%;
            flex-grow: 1;
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            font-family: var(--font-display);
        }

        /* --- Search Bar --- */
        .search-container {
            margin-bottom: 2rem;
            position: relative;
        }

        #search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: var(--font-mono);
            outline: none;
            transition: 0.3s;
        }

        #search-input:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }

        .search-icon { position: absolute; left: 1rem; top: 1.1rem; color: var(--text-muted); }

        /* --- Grid & Cards --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px -10px var(--primary-glow);
        }

        .thumbnail {
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
        }

        .card h3 { font-size: 1rem; margin-bottom: 0.4rem; color: white; }
        .card p { font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono); }

        /* --- Player Bar --- */
        .player-bar {
            background: #000;
            border-top: 1px solid var(--border);
            padding: 1rem 2rem;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            position: sticky;
            bottom: 0;
        }

        audio { filter: invert(1) hue-rotate(180deg) brightness(1.5); width: 100%; }

        /* --- Auth Modal --- */
        #auth-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 3rem;
            border: 1px solid var(--primary);
            border-radius: 12px;
            width: 400px;
            text-align: center;
            box-shadow: 0 0 40px var(--primary-glow);
        }

        input[type="email"], input[type="password"] {
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0;
            background: #000;
            border: 1px solid var(--border);
            color: white;
            font-family: var(--font-mono);
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            font-family: var(--font-mono);
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 1rem;
            cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center;">
            <h1 onclick="showPage('home')">Audio<span>tube</span></h1>
            <nav>
                <a class="nav-link active" id="nav-home" onclick="showPage('home')">Home</a>
                <a class="nav-link" id="nav-tracks" onclick="showPage('tracks')">Tracks</a>
            </nav>
        </div>
        
        <div class="nav-right" style="display: flex; gap: 1rem; align-items: center;">
            <button id="sign-in-btn" class="nav-link" style="background:none; border:1px solid var(--border); padding: 5px 15px; border-radius: 4px;" onclick="toggleModal(true)">Sign In</button>
            <label for="upload-input" id="upload-label" class="nav-link hidden" style="color: var(--primary); cursor:pointer;">[ UPLOAD ]</label>
            <input type="file" id="upload-input" class="hidden" accept="audio/*">
            <button id="logout-btn" class="hidden" onclick="signOut()" style="background:none; border:none; color:var(--text-muted); cursor:pointer"><i data-lucide="log-out"></i></button>
        </div>
    </header>

    <div id="auth-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem; font-family: var(--font-mono);">AUTH_REQUIRED</h2>
            <input type="email" id="auth-email" placeholder="USER_EMAIL">
            <input type="password" id="auth-password" placeholder="USER_PASS">
            <button class="btn-primary" onclick="executeAuth()">Initialize Session</button>
            <p onclick="toggleModal(false)" style="margin-top: 1rem; color: var(--text-muted); cursor: pointer; font-size: 0.8rem;">ABORT</p>
        </div>
    </div>

    <div class="container" id="page-home">
        <h2 class="section-title">Recommended<span>_</span></h2>
        <div class="grid" id="recommended-grid">
            </div>
    </div>

    <div class="container hidden" id="page-tracks">
        <h2 class="section-title">All_Tracks<span>_</span></h2>
        <div class="search-container">
            <i data-lucide="search" class="search-icon"></i>
            <input type="text" id="search-input" placeholder="SEARCH_DATABASE..." oninput="filterTracks()">
        </div>
        <div class="grid" id="all-tracks-grid">
            </div>
    </div>

    <div class="player-bar">
        <div id="track-info">
            <p id="now-playing-title" style="color: white; font-weight: bold; font-size: 0.9rem;">No track selected</p>
            <p id="now-playing-author" style="color: var(--text-muted); font-size: 0.7rem; font-family: var(--font-mono);"></p>
        </div>
        <audio id="main-audio" controls></audio>
        <div style="text-align: right; font-family: var(--font-mono); font-size: 0.7rem; color: var(--primary);">STATUS: READY</div>
    </div>

    <script>
        const SB_URL = 'https://kjohvagqtfcxbpwpldrs.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtqb2h2YWdxdGZjeGJwd3BsZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTI0NjcsImV4cCI6MjA4Nzg2ODQ2N30.nJxUOL7ay9G4i9RpbeXbO1x4-wOmXYc8eWrwRuLcSXg'; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        let allTracksData = [];

        function showPage(page) {
            document.getElementById('page-home').classList.toggle('hidden', page !== 'home');
            document.getElementById('page-tracks').classList.toggle('hidden', page !== 'tracks');
            document.getElementById('nav-home').classList.toggle('active', page === 'home');
            document.getElementById('nav-tracks').classList.toggle('active', page === 'tracks');
            if(page === 'tracks') filterTracks();
        }

        function toggleModal(show) { document.getElementById('auth-modal').style.display = show ? 'flex' : 'none'; }

        async function updateUI() {
            const { data: { user } } = await _supabase.auth.getUser();
            document.getElementById('upload-label').classList.toggle('hidden', !user);
            document.getElementById('logout-btn').classList.toggle('hidden', !user);
            document.getElementById('sign-in-btn').classList.toggle('hidden', !!user);
        }

        async function fetchTracks() {
            const { data: tracks } = await _supabase.from('audiotube_tracks').select('*').order('created_at', {ascending: false});
            allTracksData = tracks || [];
            
            // Render Recommended (Latest 4)
            renderGrid(allTracksData.slice(0, 4), 'recommended-grid');
            // Render All
            renderGrid(allTracksData, 'all-tracks-grid');
            lucide.createIcons();
        }

        function renderGrid(data, elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = data.length ? '' : '<p style="color:var(--text-muted)">NO_DATA_FOUND</p>';
            data.forEach(t => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="thumbnail"><i data-lucide="play" color="#ff4500"></i></div>
                    <h3>${t.title}</h3>
                    <p>> ${t.author.split('@')[0]}</p>
                `;
                card.onclick = () => playTrack(t);
                container.appendChild(card);
            });
        }

        function filterTracks() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allTracksData.filter(t => t.title.toLowerCase().includes(query));
            renderGrid(filtered, 'all-tracks-grid');
            lucide.createIcons();
        }

        function playTrack(t) {
            const player = document.getElementById('main-audio');
            player.src = t.url;
            player.play();
            document.getElementById('now-playing-title').innerText = t.title;
            document.getElementById('now-playing-author').innerText = `AUTHOR: ${t.author.split('@')[0]}`;
        }

        // Auth Logic
        async function executeAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) await _supabase.auth.signUp({ email, password });
            toggleModal(false);
            updateUI();
        }

        async function signOut() { await _supabase.auth.signOut(); updateUI(); }

        // Upload Logic
        document.getElementById('upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const { data: { user } } = await _supabase.auth.getUser();
            const fileName = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
            await _supabase.storage.from('songs').upload(fileName, file);
            const { data: { publicUrl } } = _supabase.storage.from('songs').getPublicUrl(fileName);
            await _supabase.from('audiotube_tracks').insert([{ title: file.name.split('.')[0], url: publicUrl, author: user.email }]);
            fetchTracks();
        });

        window.onload = () => { updateUI(); fetchTracks(); lucide.createIcons(); };
    </script>
</body>
</html>
